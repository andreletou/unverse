{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/detail.css' %}">
<div class="product-detail-page">
    <!-- Breadcrumb amélioré -->
    <nav class="breadcrumb-nav" aria-label="Fil d'Ariane">
        <ol>
            <li><a href="{% url 'core:home' %}">Accueil</a></li>
            <li><a href="{% url 'core:product_list_by_category' category_slug=product.category.slug %}">{{ product.category.name }}</a></li>
            <li aria-current="page">{{ product.name|truncatechars:30 }}</li>
        </ol>
    </nav>

    <div class="product-detail-container">
        <!-- Galerie d'images améliorée -->
        <div class="product-gallery">
            <div class="main-image-container">
                <img src="{{ main_image.image.url }}" 
                     alt="{{ main_image.alt_text|default:product.name }}" 
                     class="main-image" 
                     id="zoom-image"
                     data-zoom-image="{{ main_image.image.url }}">
                <button class="zoom-btn" aria-label="Zoom sur l'image">
                    <i class="fas fa-search-plus"></i>
                </button>
            </div>
            
            <div class="thumbnail-carousel">
                {% for image in other_images %}
                <div class="thumbnail-item {% if forloop.first %}active{% endif %}" 
                     data-image="{{ image.image.url }}"
                     data-zoom-image="{{ image.image.url }}">
                    <img src="{{ image.image.url }}" 
                         alt="{{ image.alt_text|default:product.name }}"
                         loading="lazy">
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Section d'information principale -->
        <div class="product-info-main">
            <div class="product-heading">
                <h1>{{ product.name }}</h1>
                <div class="product-meta">
                    <span class="sku">Réf: {{ product.sku }}</span>
                    <span class="availability {% if product.is_available %}in-stock{% else %}out-of-stock{% endif %}">
                        {% if product.is_available %}
                        <i class="fas fa-check-circle"></i> En stock
                        {% else %}
                        <i class="fas fa-times-circle"></i> Rupture
                        {% endif %}
                    </span>
                </div>
            </div>

            <!-- Évaluations -->
            <div class="product-ratings">
                <div class="rating-summary">
                    <div class="stars" style="--rating: {{ product.rating|default:0 }};"></div>
                    <a href="#reviews" class="rating-count">
                        {{ total_reviews }} avis
                    </a>
                </div>
                {% if product.is_on_sale %}
                <span class="discount-badge">-{{ product.get_discount_percentage }}%</span>
                {% endif %}
            </div>

            <!-- Prix -->
            <div class="product-price-box">
                {% if product.is_on_sale %}
                <span class="old-price">{{ product.original_price }} FCFA</span>
                {% endif %}
                <span class="final-price">{{ product.price }} FCFA</span>
                {% if product.is_on_sale %}
                <span class="price-saved">Économisez {{ product.get_savings }} FCFA</span>
                {% endif %}
            </div>

            <!-- Sélecteur de variantes (couleurs, tailles, etc.) -->
            {% if product.colors %}
            <div class="product-variants">
                <h3>Couleurs disponibles:</h3>
                <div class="color-swatches">
                    {% for color in product.colors %}
                    <div class="color-swatch {% if forloop.first %}active{% endif %}" 
                         data-color="{{ color }}"
                         title="{{ color }}"
                         style="background-color: {{ color|lower }};"></div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Sélecteur de quantité -->
            <div class="product-qty">
                <label for="qty">Quantité:</label>
                <div class="qty-selector">
                    <button class="qty-btn minus" aria-label="Réduire la quantité">-</button>
                    <input type="number" 
                           id="qty" 
                           value="1" 
                           min="1" 
                           max="{{ product.stock_quantity }}" 
                           class="qty-input">
                    <button class="qty-btn plus" aria-label="Augmenter la quantité">+</button>
                </div>
                {% if product.stock_quantity %}
                <div class="stock-indicator">
                    <div class="stock-bar" style="--stock-level: {% widthratio product.stock_quantity product.stock_quantity 100 %}%"></div>
                    <span>{{ product.stock_quantity }} disponible(s)</span>
                </div>
                {% endif %}
            </div>

            <!-- Boutons d'action -->
            <div class="product-actions">
                <button class="btn-add-to-cart" 
                        data-product-id="{{ product.id }}"
                        {% if not product.is_available %}disabled{% endif %}>
                    <i class="fas fa-shopping-cart"></i>
                    Ajouter au panier
                </button>
                <button class="btn-buy-now" 
                        data-product-id="{{ product.id }}"
                        {% if not product.is_available %}disabled{% endif %}>
                    Acheter maintenant
                </button>
                <button class="btn-wishlist {% if is_favorite %}active{% endif %}" 
                        data-product-id="{{ product.id }}"
                        aria-label="{% if is_favorite %}Retirer des favoris{% else %}Ajouter aux favoris{% endif %}">
                    <i class="fas fa-heart"></i>
                </button>
            </div>

            <!-- Livraison et retours -->
            <div class="delivery-options">
                <div class="delivery-option">
                    <i class="fas fa-truck"></i>
                    <div>
                        <strong>Livraison standard:</strong>
                        <span>5 000 FCFA - Livré sous 2-5 jours</span>
                    </div>
                </div>
                <div class="delivery-option">
                    <i class="fas fa-sync-alt"></i>
                    <div>
                        <strong>Retours faciles:</strong>
                        <span>30 jours pour changer d'avis</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Onglets de détail -->
    <div class="product-tabs-container">
        <div class="product-tabs-nav">
            <button class="tab-btn active" data-tab="description">Description</button>
            <button class="tab-btn" data-tab="specifications">Caractéristiques</button>
            <button class="tab-btn" data-tab="reviews">Avis ({{ total_reviews }})</button>
        </div>

        <div class="product-tabs-content">
            <!-- Description -->
            <div id="description" class="tab-panel active">
                <div class="product-description">
                    {{ product.description|linebreaks }}
                </div>
                
                {% if product.features.exists %}
                <div class="highlighted-features">
                    <h3>Points clés</h3>
                    <ul>
                        {% for feature in product.features.all|slice:":5" %}
                        <li>
                            <i class="fas {{ feature.icon|default:'fa-check' }}"></i>
                            <strong>{{ feature.name }}:</strong> {{ feature.value }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>

            <!-- Caractéristiques -->
            <div id="specifications" class="tab-panel">
                <div class="specs-grid">
                    {% for feature in product.features.all %}
                    <div class="spec-row">
                        <div class="spec-name">{{ feature.name }}</div>
                        <div class="spec-value">{{ feature.value }}</div>
                    </div>
                    {% endfor %}
                    
                    {% if product.weight or product.dimensions %}
                    <div class="spec-row">
                        <div class="spec-name">Dimensions et poids</div>
                        <div class="spec-value">
                            {% if product.dimensions %}{{ product.dimensions }}{% endif %}
                            {% if product.weight %} • {{ product.weight }}g{% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Avis -->
            <div id="reviews" class="tab-panel">
                <div class="reviews-header">
                    <div class="reviews-summary">
                        <div class="average-rating">
                            <span class="rating-value">{{ product.rating|floatformat:1 }}</span>
                            <div class="stars" style="--rating: {{ product.rating|default:0 }};"></div>
                            <span class="rating-count">{{ total_reviews }} avis</span>
                        </div>
                        
                        <div class="rating-distribution">
                            {% for i in "54321" %}
                            {% with i=i|add:"0" %}
                            <div class="rating-bar">
                                <span class="stars">
                                    {% for star in "12345" %}
                                        {% if forloop.counter <= i %}
                                            <i class="fas fa-star"></i>
                                        {% else %}
                                            <i class="far fa-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                </span>
                                <div class="bar-container">
                                    <div class="bar" style="width: {% widthratio rating_stats.i|default:0 total_reviews 100 %}%"></div>
                                </div>
                                <span class="count">{{ rating_stats.i|default:0 }}</span>
                            </div>
                            {% endwith %}
                            {% endfor %}
                        </div>
                    </div>
                    
                    {% if user.is_authenticated %}
                    <button class="btn-write-review" id="write-review-btn">
                        <i class="fas fa-pen"></i> Écrire un avis
                    </button>
                    {% endif %}
                </div>

                <!-- Formulaire d'avis (caché par défaut) -->
                {% if user.is_authenticated %}
                <div class="review-form-container" id="review-form-container" style="display: none;">
                    <h3>Donnez votre avis</h3>
                    <form method="post" class="review-form" id="review-form" action="{% url 'core:submit_review' product_id=product.id %}">
                        {% csrf_token %}
                        <div class="form-group">
                            <label>Note</label>
                            <div class="rating-input">
                                {% for i in "54321" %}
                                <input type="radio" 
                                       id="rating-{{ i }}" 
                                       name="rating" 
                                       value="{{ i }}"
                                       {% if review_form.rating.value == i %}checked{% endif %}>
                                <label for="rating-{{ i }}" title="{{ i }} étoiles">
                                    <i class="far fa-star"></i>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="form-group">
                            {{ review_form.title }}
                        </div>
                        <div class="form-group">
                            {{ review_form.comment }}
                        </div>
                        <button type="submit" class="btn-submit-review">
                            Publier l'avis
                        </button>
                    </form>
                </div>
                {% else %}
                <div class="login-prompt">
                    <p><a href="{% url 'core:login' %}?next={% url 'core:product_detail' slug=product.slug %}">Connectez-vous</a> pour donner votre avis sur ce produit.</p>
                </div>
                {% endif %}

                <!-- Liste des avis -->
                <div class="reviews-list">
                    {% for review in reviews %}
                    <div class="review-item">
                        <div class="review-header">
                            <div class="reviewer-avatar">
                                {{ review.user.username|first|upper }}
                            </div>
                            <div class="reviewer-info">
                                <h4>{{ review.user.username }}</h4>
                                <div class="review-meta">
                                    <div class="stars" style="--rating: {{ review.rating }};"></div>
                                    <span class="review-date">{{ review.created_at|date:"d M Y" }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="review-content">
                            <h5>{{ review.title }}</h5>
                            <p>{{ review.comment }}</p>
                        </div>
                    </div>
                    {% empty %}
                    <div class="no-reviews">
                        <i class="far fa-comment-dots"></i>
                        <p>Aucun avis pour ce produit. Soyez le premier à donner votre avis!</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Produits similaires -->
    <section class="related-products">
        <h2>Vous pourriez aussi aimer</h2>
        <div class="products-carousel">
            {% for product in similar_products %}
            <div class="product-card">
                {% include 'products/product_card.html' %}
            </div>
            {% endfor %}
        </div>
    </section>
</div>
<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Changement d'image principale
    document.querySelectorAll('.thumbnail-item').forEach(thumb => {
        thumb.addEventListener('click', function() {
            // Retirer la classe active de toutes les miniatures
            document.querySelectorAll('.thumbnail-item').forEach(t => t.classList.remove('active'));
            
            // Ajouter la classe active à la miniature cliquée
            this.classList.add('active');
            
            // Changer l'image principale
            const mainImg = document.getElementById('zoom-image');
            mainImg.src = this.dataset.image;
            mainImg.dataset.zoomImage = this.dataset.zoomImage;
        });
    });
    
    // Gestion des onglets
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Retirer la classe active de tous les boutons et panneaux
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            
            // Ajouter la classe active au bouton cliqué
            this.classList.add('active');
            
            // Afficher le panneau correspondant
            const tabId = this.dataset.tab;
            document.getElementById(tabId).classList.add('active');
            
            // Faire défiler jusqu'au panneau
            document.getElementById(tabId).scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
    });
    
    // Gestion de la quantité
    document.querySelectorAll('.qty-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const input = this.parentElement.querySelector('.qty-input');
            let value = parseInt(input.value);
            const max = parseInt(input.max) || Infinity;
            
            if (this.classList.contains('minus') && value > 1) {
                input.value = value - 1;
            } else if (this.classList.contains('plus') && value < max) {
                input.value = value + 1;
            }
        });
    });
    
    // Validation de la quantité manuelle
    document.querySelector('.qty-input').addEventListener('change', function() {
        const value = parseInt(this.value);
        const min = parseInt(this.min) || 1;
        const max = parseInt(this.max) || Infinity;
        
        if (isNaN(value) || value < min) {
            this.value = min;
        } else if (value > max) {
            this.value = max;
        }
    });
    
    // Bouton pour écrire un avis
    const writeReviewBtn = document.getElementById('write-review-btn');
    if (writeReviewBtn) {
        writeReviewBtn.addEventListener('click', function() {
            const formContainer = document.getElementById('review-form-container');
            formContainer.style.display = formContainer.style.display === 'block' ? 'none' : 'block';
            if (formContainer.style.display === 'block') {
                formContainer.scrollIntoView({ behavior: 'smooth' });
            }
        });
    }
    
    // Zoom sur l'image (simplifié)
    const zoomImage = document.getElementById('zoom-image');
    if (zoomImage) {
        zoomImage.addEventListener('click', function() {
            const zoomUrl = this.dataset.zoomImage;
            window.open(zoomUrl, '_blank');
        });
    }
    
    // Sélection des couleurs
    document.querySelectorAll('.color-swatch').forEach(swatch => {
        swatch.addEventListener('click', function() {
            document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
            this.classList.add('active');
            // Ici, vous pourriez ajouter une logique pour changer le produit/variante
        });
    });
    
    // Ajout au panier
    document.querySelector('.btn-add-to-cart').addEventListener('click', function() {
        const productId = this.dataset.productId;
        const quantity = document.querySelector('.qty-input').value;
        
        fetch(`/api/add-to-cart/${productId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ quantity: quantity })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erreur réseau');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                // Mettre à jour le compteur du panier dans le header
                const cartCount = document.querySelector('.cart-count');
                if (cartCount) {
                    cartCount.textContent = data.cart_items_count;
                    cartCount.classList.add('pulse');
                    setTimeout(() => cartCount.classList.remove('pulse'), 500);
                }
                
                // Afficher une notification
                alert(data.message);
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors de l\'ajout au panier');
        });
    });
    
    // Acheter
})
</script>
{% endblock %}