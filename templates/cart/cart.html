{% extends "base.html" %}
{% load static %}

{% block title %}Panier - UniversePro{% endblock %}

{% block content %}
<div class="min-h-screen bg-amazon-gray py-8">
    <div class="container mx-auto px-4 max-w-7xl">
        <!-- En-tête de page -->
        <div class="mb-8">
            <nav class="flex items-center space-x-2 text-sm text-gray-600 mb-4">
                <a href="{% url 'core:home' %}" class="hover:text-amazon-orange transition-colors">Accueil</a>
                <span class="text-gray-400">/</span>
                <span class="text-amazon-dark font-medium">Panier</span>
            </nav>
            
            <div class="text-center">
                <h1 class="text-3xl lg:text-4xl font-bold text-amazon-dark mb-3">Votre Panier</h1>
                <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                    Revoyez vos articles avant de passer commande
                </p>
            </div>
        </div>
        
        {% if cart.items.count > 0 %}
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Section des articles -->
            <div class="lg:w-2/3">
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                    <!-- En-tête des articles -->
                    <div class="flex justify-between items-center p-6 border-b border-gray-200">
                        <h2 class="text-xl font-bold text-amazon-dark">
                            Articles (<span id="cart-items-count" class="text-amazon-orange">{{ cart.items.count }}</span>)
                        </h2>
                        <button id="clear-cart-btn" 
                                class="flex items-center space-x-2 text-red-600 hover:text-red-700 transition-colors">
                            <i class="fas fa-trash text-sm"></i>
                            <span class="font-medium">Vider le panier</span>
                        </button>
                    </div>
                    
                    <!-- Liste des articles -->
                    <div class="divide-y divide-gray-100">
                        {% for item in cart.items.all %}
                        <div class="cart-item p-6 hover:bg-gray-50 transition-colors" data-id="{{ item.id }}">
                            <div class="flex flex-col sm:flex-row gap-4">
                                <!-- Image du produit -->
                                <div class="flex-shrink-0">
                                    <div class="w-24 h-24 bg-gray-100 rounded-xl overflow-hidden">
                                        {% if item.product.images.first %}
                                        <img src="{{ item.product.images.first.image.url }}" 
                                             alt="{{ item.product.name }}"
                                             class="w-full h-full object-cover">
                                        {% else %}
                                        <div class="w-full h-full flex items-center justify-center bg-gray-200">
                                            <i class="fas fa-image text-gray-400 text-xl"></i>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Détails du produit -->
                                <div class="flex-grow min-w-0">
                                    <h3 class="font-semibold text-amazon-dark text-lg mb-2 truncate">
                                        {{ item.product.name }}
                                    </h3>
                                    <p class="text-2xl font-bold text-amazon-orange mb-2">
                                        {{ item.price|floatformat:0 }} FCFA
                                    </p>
                                    <div class="flex items-center space-x-2 text-sm">
                                        {% if item.product.stock_quantity %}
                                        <span class="flex items-center space-x-1 text-green-600">
                                            <i class="fas fa-check-circle"></i>
                                            <span>En stock ({{ item.product.stock_quantity }} disponibles)</span>
                                        </span>
                                        {% else %}
                                        <span class="flex items-center space-x-1 text-green-600">
                                            <i class="fas fa-check-circle"></i>
                                            <span>En stock</span>
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Quantité et actions -->
                                <div class="flex flex-col items-end space-y-4">
                                    <!-- Sélecteur de quantité -->
                                    <div class="flex items-center space-x-3">
                                        <div class="flex items-center border border-gray-300 rounded-xl overflow-hidden">
                                            <button class="quantity-btn minus w-10 h-10 flex items-center justify-center bg-gray-50 hover:bg-gray-100 transition-colors">
                                                <i class="fas fa-minus text-gray-600"></i>
                                            </button>
                                            <input type="number" 
                                                   class="quantity-input w-12 h-10 text-center border-x border-gray-300 focus:outline-none focus:ring-2 focus:ring-amazon-orange"
                                                   value="{{ item.quantity }}" 
                                                   min="1" 
                                                   {% if item.product.stock_quantity %}max="{{ item.product.stock_quantity }}"{% endif %}>
                                            <button class="quantity-btn plus w-10 h-10 flex items-center justify-center bg-gray-50 hover:bg-gray-100 transition-colors">
                                                <i class="fas fa-plus text-gray-600"></i>
                                            </button>
                                        </div>
                                        
                                        <!-- Prix total -->
                                        <div class="text-right">
                                            <p class="text-lg font-bold text-amazon-dark">
                                                {{ item.total_price|floatformat:0 }} FCFA
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <!-- Bouton supprimer -->
                                    <button class="remove-item flex items-center space-x-2 text-red-600 hover:text-red-700 transition-colors text-sm"
                                            data-item-id="{{ item.id }}">
                                        <i class="fas fa-trash"></i>
                                        <span>Supprimer</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Actions du panier -->
                    <div class="p-6 border-t border-gray-200">
                        <a href="{% url 'core:product_list' %}" 
                           class="inline-flex items-center space-x-2 text-amazon-blue hover:text-amazon-orange transition-colors font-medium">
                            <i class="fas fa-arrow-left"></i>
                            <span>Continuer mes achats</span>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Récapitulatif de commande -->
            <div class="lg:w-1/3">
                <div class="sticky top-8">
                    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                        <!-- En-tête récapitulatif -->
                        <div class="bg-gradient-to-r from-amazon-blue to-blue-600 p-6">
                            <div class="flex items-center space-x-3 text-white">
                                <i class="fas fa-receipt text-xl"></i>
                                <h3 class="text-xl font-bold">Récapitulatif</h3>
                            </div>
                        </div>
                        
                        <!-- Détails du récapitulatif -->
                        <div class="p-6 space-y-4">
                            <!-- Sous-total -->
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Sous-total</span>
                                <span id="subtotal" class="font-semibold text-lg">{{ cart.subtotal|floatformat:0 }} FCFA</span>
                            </div>
                            
                            <!-- Réduction coupon -->
                            {% if cart.coupon %}
                            <div class="flex justify-between items-center text-green-600">
                                <span>Réduction ({{ cart.coupon.code }})</span>
                                <span id="discount" class="font-semibold">-{{ cart.coupon_discount|floatformat:0 }} FCFA</span>
                            </div>
                            {% endif %}
                            
                            <!-- Livraison -->
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Livraison</span>
                                <span id="shipping" class="font-semibold">
                                    {% if cart.shipping_cost == 0 %}
                                        <span class="text-green-600">Gratuit</span>
                                    {% else %}
                                        {{ cart.shipping_cost|floatformat:0 }} FCFA
                                    {% endif %}
                                </span>
                            </div>
                            
                            <!-- Ligne de séparation -->
                            <div class="border-t border-gray-200 pt-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-xl font-bold text-amazon-dark">Total</span>
                                    <span id="total" class="text-2xl font-bold text-amazon-orange">
                                        {{ cart.total|floatformat:0 }} FCFA
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section coupon -->
                        {% if not cart.coupon %}
                        <div class="border-t border-gray-200 p-6">
                            <h4 class="flex items-center space-x-2 text-amazon-dark font-semibold mb-3">
                                <i class="fas fa-tag text-amazon-orange"></i>
                                <span>Code promo</span>
                            </h4>
                            <form class="coupon-form space-y-3" id="coupon-form">
                                {% csrf_token %}
                                <div class="flex space-x-2">
                                    <input type="text" 
                                           name="coupon_code" 
                                           placeholder="Entrez votre code"
                                           class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-amazon-orange focus:border-transparent">
                                    <button type="submit" 
                                            class="px-6 py-3 bg-amazon-blue text-white font-semibold rounded-xl hover:bg-blue-600 transition-colors whitespace-nowrap">
                                        Appliquer
                                    </button>
                                </div>
                                <div id="coupon-message" class="text-sm"></div>
                            </form>
                        </div>
                        {% endif %}
                        
                        <!-- Barre de progression livraison gratuite -->
                        <div class="border-t border-gray-200 p-6">
                            <div class="space-y-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Livraison gratuite</span>
                                    <span class="font-medium">
                                        {% if cart.shipping_cost == 0 %}
                                            <span class="text-green-600">Obtenue !</span>
                                        {% else %}
                                            {{ remaining_for_free_shipping|floatformat:0 }} FCFA restants
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="free-shipping-progress" 
                                         class="bg-amazon-orange h-2 rounded-full transition-all duration-500"
                                         style="width: {% widthratio cart.subtotal settings.FREE_SHIPPING_THRESHOLD 100 %}%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bouton de commande -->
                        <div class="p-6 border-t border-gray-200">
                            <a href="{% url 'core:checkout' %}" 
                               class="w-full bg-gradient-to-r from-amazon-orange to-orange-500 hover:from-orange-500 hover:to-orange-600 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center justify-center space-x-3">
                                <i class="fas fa-shopping-cart"></i>
                                <span>Passer la commande</span>
                            </a>
                            
                            <!-- Sécurité -->
                            <div class="mt-4 text-center">
                                <p class="flex items-center justify-center space-x-2 text-sm text-gray-600 mb-2">
                                    <i class="fas fa-lock text-green-500"></i>
                                    <span>Paiement 100% sécurisé</span>
                                </p>
                                <div class="flex justify-center space-x-4 text-xl text-gray-500">
                                    <i class="fab fa-cc-visa"></i>
                                    <i class="fab fa-cc-mastercard"></i>
                                    <i class="fab fa-cc-paypal"></i>
                                    <i class="fas fa-mobile-alt"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Version mobile (barre fixe en bas) -->
        <div class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-lg z-50">
            <div class="flex justify-between items-center mb-3">
                <span class="text-lg font-bold text-amazon-dark">Total</span>
                <span id="mobile-total" class="text-2xl font-bold text-amazon-orange">
                    {{ cart.total|floatformat:0 }} FCFA
                </span>
            </div>
            <a href="{% url 'core:checkout' %}" 
               class="w-full bg-gradient-to-r from-amazon-orange to-orange-500 hover:from-orange-500 hover:to-orange-600 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 flex items-center justify-center space-x-3">
                <i class="fas fa-shopping-cart"></i>
                <span>Passer commande</span>
            </a>
        </div>
        
        {% else %}
        <!-- Panier vide -->
        <div class="max-w-2xl mx-auto text-center py-16">
            <div class="bg-white rounded-2xl shadow-lg p-12">
                <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-shopping-cart text-4xl text-gray-400"></i>
                </div>
                <h3 class="text-2xl font-bold text-amazon-dark mb-4">Votre panier est vide</h3>
                <p class="text-gray-600 text-lg mb-8 max-w-md mx-auto">
                    Parcourez nos produits et ajoutez des articles à votre panier
                </p>
                <a href="{% url 'core:product_list' %}" 
                   class="inline-flex items-center space-x-3 bg-gradient-to-r from-amazon-blue to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-4 px-8 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                    <i class="fas fa-store"></i>
                    <span>Commencer mes achats</span>
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion des quantités
    document.querySelectorAll('.quantity-btn.minus').forEach(button => {
        button.addEventListener('click', function() {
            const input = this.nextElementSibling;
            if (parseInt(input.value) > 1) {
                input.value = parseInt(input.value) - 1;
                updateCartItem(input);
            }
        });
    });

    document.querySelectorAll('.quantity-btn.plus').forEach(button => {
        button.addEventListener('click', function() {
            const input = this.previousElementSibling;
            const max = parseInt(input.getAttribute('max'));
            if (!max || parseInt(input.value) < max) {
                input.value = parseInt(input.value) + 1;
                updateCartItem(input);
            } else {
                showToast('Quantité maximale disponible atteinte', 'error');
            }
        });
    });

    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('change', function() {
            const max = parseInt(this.getAttribute('max'));
            if (max && parseInt(this.value) > max) {
                this.value = max;
                showToast('Quantité ajustée au stock disponible', 'warning');
            }
            updateCartItem(this);
        });
        
        input.addEventListener('blur', function() {
            if (this.value === '' || parseInt(this.value) < 1) {
                this.value = 1;
                updateCartItem(this);
            }
        });
    });

    // Suppression d'article avec confirmation
    document.querySelectorAll('.remove-item').forEach(button => {
        button.addEventListener('click', function() {
            const itemId = this.getAttribute('data-item-id');
            const itemName = this.closest('.cart-item').querySelector('h3').textContent;
            
            if (confirm(`Êtes-vous sûr de vouloir retirer "${itemName}" de votre panier ?`)) {
                removeCartItem(itemId);
            }
        });
    });

    // Vider le panier avec confirmation
    const clearCartBtn = document.getElementById('clear-cart-btn');
    if (clearCartBtn) {
        clearCartBtn.addEventListener('click', function() {
            if (confirm('Êtes-vous sûr de vouloir vider complètement votre panier ?')) {
                fetch('{% url "core:clear_cart" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'cleared') {
                        showToast(data.message, 'success');
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Erreur lors de la suppression du panier', 'error');
                });
            }
        });
    }

    // Application du coupon
    const couponForm = document.getElementById('coupon-form');
    if (couponForm) {
        couponForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // État de chargement
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            submitBtn.disabled = true;
            
            fetch('{% url "core:apply_coupon" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const message = document.getElementById('coupon-message');
                message.className = 'text-sm font-medium p-3 rounded-lg';
                
                if (data.status === 'success') {
                    message.classList.add('bg-green-100', 'text-green-700', 'border', 'border-green-200');
                    message.textContent = data.message;
                    showToast(data.message, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    message.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-200');
                    message.textContent = data.message;
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Erreur lors de l\'application du coupon', 'error');
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });
    }

    // Fonctions utilitaires
    function updateCartItem(input) {
        const itemId = input.closest('.cart-item').getAttribute('data-id');
        const quantity = parseInt(input.value);
        const itemElement = input.closest('.cart-item');
        
        // État de chargement
        const originalValue = input.value;
        input.disabled = true;
        itemElement.classList.add('opacity-50');
        
        fetch(`{% url "core:update_cart_item" 0 %}`.replace('0', itemId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quantity: quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'updated') {
                // Mise à jour des totaux
                document.getElementById('subtotal').textContent = parseFloat(data.subtotal).toFixed(0) + ' FCFA';
                document.getElementById('total').textContent = parseFloat(data.total).toFixed(0) + ' FCFA';
                document.getElementById('mobile-total').textContent = parseFloat(data.total).toFixed(0) + ' FCFA';
                
                // Mise à jour du prix total de l'article
                const itemTotalElement = itemElement.querySelector('.text-amazon-dark');
                if (itemTotalElement) {
                    itemTotalElement.textContent = parseFloat(data.item_total).toFixed(0) + ' FCFA';
                }
                
                // Mise à jour de la livraison
                const shippingElement = document.getElementById('shipping');
                if (parseFloat(data.shipping) === 0) {
                    shippingElement.innerHTML = '<span class="text-green-600">Gratuit</span>';
                } else {
                    shippingElement.textContent = parseFloat(data.shipping).toFixed(0) + ' FCFA';
                }
                
                showToast('Quantité mise à jour', 'success');
            } else if (data.status === 'error') {
                showToast(data.message, 'error');
                input.value = data.available_quantity || originalValue;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Erreur lors de la mise à jour', 'error');
            input.value = originalValue;
        })
        .finally(() => {
            input.disabled = false;
            itemElement.classList.remove('opacity-50');
        });
    }

    function removeCartItem(itemId) {
        const itemElement = document.querySelector(`.cart-item[data-id="${itemId}"]`);
        itemElement.classList.add('opacity-50');
        
        fetch(`{% url "core:remove_cart_item" 0 %}`.replace('0', itemId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'removed') {
                // Animation de suppression
                itemElement.style.transition = 'all 0.3s ease';
                itemElement.style.height = itemElement.offsetHeight + 'px';
                setTimeout(() => {
                    itemElement.style.height = '0';
                    itemElement.style.opacity = '0';
                    itemElement.style.margin = '0';
                    itemElement.style.padding = '0';
                }, 10);
                
                setTimeout(() => {
                    itemElement.remove();
                    
                    // Mise à jour des totaux
                    document.getElementById('subtotal').textContent = parseFloat(data.subtotal).toFixed(0) + ' FCFA';
                    document.getElementById('total').textContent = parseFloat(data.total).toFixed(0) + ' FCFA';
                    document.getElementById('mobile-total').textContent = parseFloat(data.total).toFixed(0) + ' FCFA';
                    
                    // Mise à jour du compteur d'articles
                    const itemsCount = document.querySelectorAll('.cart-item').length;
                    document.getElementById('cart-items-count').textContent = itemsCount;
                    
                    // Mise à jour de la livraison
                    const shippingElement = document.getElementById('shipping');
                    if (parseFloat(data.shipping) === 0) {
                        shippingElement.innerHTML = '<span class="text-green-600">Gratuit</span>';
                    } else {
                        shippingElement.textContent = parseFloat(data.shipping).toFixed(0) + ' FCFA';
                    }
                    
                    showToast('Article retiré du panier', 'success');
                    
                    // Si panier vide, recharger la page
                    if (itemsCount === 0) {
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    }
                }, 300);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Erreur lors de la suppression', 'error');
            itemElement.classList.remove('opacity-50');
        });
    }

    // Toast notification amélioré
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        const typeConfig = {
            success: { bg: 'bg-green-500', icon: 'fa-check-circle' },
            error: { bg: 'bg-red-500', icon: 'fa-exclamation-circle' },
            warning: { bg: 'bg-yellow-500', icon: 'fa-exclamation-triangle' },
            info: { bg: 'bg-blue-500', icon: 'fa-info-circle' }
        };
        
        const config = typeConfig[type] || typeConfig.success;
        
        toast.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-xl shadow-2xl text-white transform transition-all duration-300 translate-x-full ${config.bg}`;
        toast.innerHTML = `
            <div class="flex items-center space-x-3">
                <i class="fas ${config.icon} text-xl"></i>
                <span class="font-semibold">${message}</span>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Animation d'entrée
        setTimeout(() => {
            toast.classList.remove('translate-x-full');
            toast.classList.add('translate-x-0');
        }, 10);
        
        // Animation de sortie
        setTimeout(() => {
            toast.classList.remove('translate-x-0');
            toast.classList.add('translate-x-full');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Animation de chargement pour les boutons
    function setLoadingState(button, isLoading) {
        if (isLoading) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.classList.add('opacity-50');
        } else {
            button.disabled = false;
            button.innerHTML = button.getAttribute('data-original-text') || button.innerHTML;
            button.classList.remove('opacity-50');
        }
    }

    // Sauvegarder le texte original des boutons
    document.querySelectorAll('button').forEach(button => {
        button.setAttribute('data-original-text', button.innerHTML);
    });
});
</script>

<style>
/* Animations personnalisées */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.cart-item {
    animation: slideIn 0.3s ease-out;
}

/* Styles pour les inputs number */
.quantity-input::-webkit-outer-spin-button,
.quantity-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.quantity-input[type=number] {
    -moz-appearance: textfield;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .cart-item {
        padding: 1rem;
    }
    
    .quantity-input {
        width: 3rem;
    }
}

/* Amélioration de l'accessibilité */
@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}
</style>
{% endblock %}